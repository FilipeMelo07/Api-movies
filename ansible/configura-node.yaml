---
- name: Configurar e instalar API Node.js
  hosts: docker_servers
  become: yes
  gather_facts: yes
  
  vars:
    app_name: "minha-api"
    app_dir: "/app"
    git_repo: "https://github.com/FilipeMelo07/Api-movies.git"
    git_branch: "main"
    node_env: "{{ app_env | default('development') }}"
    
  tasks:
    - name: Atualizar cache do apt
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: Instalar dependências básicas
      apt:
        name:
          - curl
          - git
          - build-essential
        state: present
    
    - name: Adicionar repositório NodeSource
      shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      args:
        creates: /etc/apt/sources.list.d/nodesource.list
    
    - name: Instalar Node.js
      apt:
        name: nodejs
        state: present
        update_cache: yes
    
    - name: Verificar versão do Node.js
      command: node --version
      register: node_version
      changed_when: false
    
    - name: Verificar versão do npm
      command: npm --version
      register: npm_version
      changed_when: false
    
    - name: Exibir versões instaladas
      debug:
        msg: "Node.js {{ node_version.stdout }} e npm {{ npm_version.stdout }}"
    
    - name: Instalar PM2 globalmente
      npm:
        name: pm2
        global: yes
        state: present
    
    - name: Criar diretório da aplicação
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
    
    - name: Verificar se é um repositório Git válido
      uri:
        url: "{{ git_repo }}"
        method: HEAD
        status_code: [200, 301, 302]
      register: git_check
      ignore_errors: yes
      when: git_repo is defined
    
    - name: Clonar repositório da API
      git:
        repo: "{{ git_repo }}"
        dest: "{{ app_dir }}"
        version: "{{ git_branch }}"
        force: yes
      when: 
        - git_repo is defined
        - git_check is succeeded
    
    - name: Criar aplicação de exemplo se não tiver repositório
      copy:
        content: |
          const express = require('express');
          const app = express();
          const PORT = process.env.PORT || 3000;
          
          app.get('/', (req, res) => {
            res.json({ 
              message: 'API Movies funcionando!', 
              timestamp: new Date(),
              ambiente: process.env.NODE_ENV 
            });
          });
          
          app.get('/health', (req, res) => {
            res.json({ 
              status: 'healthy', 
              uptime: process.uptime(),
              version: '1.0.0'
            });
          });
          
          app.listen(PORT, '0.0.0.0', () => {
            console.log(`API rodando na porta ${PORT}`);
          });
        dest: "{{ app_dir }}/index.js"
        mode: '0644'
      when: git_check is not succeeded or git_repo is not defined
    
    - name: Verificar se package.json existe
      stat:
        path: "{{ app_dir }}/package.json"
      register: package_json
    
    - name: Criar package.json se não existir
      copy:
        content: |
          {
            "name": "api-movies",
            "version": "1.0.0",
            "main": "index.js",
            "dependencies": {
              "express": "^4.18.0"
            }
          }
        dest: "{{ app_dir }}/package.json"
        mode: '0644'
      when: not package_json.stat.exists
    
    - name: Instalar dependências npm
      npm:
        path: "{{ app_dir }}"
        state: present
    
    - name: Parar processos PM2 existentes
      command: pm2 delete all
      ignore_errors: yes
    
    - name: Iniciar API com PM2
      command: pm2 start {{ app_dir }}/index.js --name "{{ app_name }}"
      environment:
        NODE_ENV: "{{ node_env }}"
    
    - name: Salvar processos PM2
      command: pm2 save
    
    - name: Aguardar API iniciar
      wait_for:
        port: "{{ app_port }}"
        delay: 2
        timeout: 10
    
